;var taskjobs={};taskjobs.show_form=function(t,e,s){$("#taskjobs_form").html(t)};taskjobs.hide_form=function(){$("#taskjobs_form").html("")};taskjobs.register_update_method=function(t){$("#"+t).off("change","*").on("change",function(t){$("#method_selected").text($(this).val());taskjobs.hide_moduletypes_dropdown();taskjobs.hide_moduleitems_dropdown();taskjobs.clear_list("targets");taskjobs.clear_list("actors")})};taskjobs.register_update_items=function(t,e,s){$("#"+t).off("change","*").on("change",function(t){taskjobs.show_moduleitems(s,e,$(this).val())})};taskjobs.register_form_changed=function(){$("form[name=form_taskjob]").off("change","*").on("change",function(t){$("#cancel_job_changes_button").show()})};taskjobs.create=function(t,e){$.ajax({url:t,data:{"task_id":e},success:taskjobs.show_form})};taskjobs.edit=function(t,e){$.ajax({url:t,data:{"id":e},success:taskjobs.show_form})};taskjobs.hide_moduletypes_dropdown=function(){$("#taskjob_moduletypes_dropdown").html("")};taskjobs.show_moduletypes_dropdown=function(t){$("#taskjob_moduletypes_dropdown").html(t)};taskjobs.hide_moduleitems_dropdown=function(){$("#taskjob_moduleitems_dropdown").html("")};taskjobs.show_moduleitems_dropdown=function(t){$("#taskjob_moduleitems_dropdown").html(t)};taskjobs.clear_list=function(t){$("#taskjob_"+t+"_list").html("")};taskjobs.delete_items_selected=function(t){$("#taskjob_"+t+"_list").find(".taskjob_item").has("input[type=checkbox]:checked").remove()};taskjobs.add_item=function(t,e,s,a){item_id=$("#"+a).val();item_name=$("#taskjob_moduleitems_dropdown .select2-chosen").text();if(item_id>0){item_to_add={"id":e+"-"+item_id,"name":item_name};item_exists=$("#taskjob_"+t+"_list").find("#"+item_to_add.id);if(item_exists.length===0){$("#taskjob_"+t+"_list").append("<div class='taskjob_item new' id='"+item_to_add.id+"'  >  <input type='checkbox'>  </input>  <span class='"+e+"'></span>  <label>     <span style='font-style:oblique'>"+s+"</span>     "+item_to_add.name+"  </label>  <input type='hidden' name='"+t+"[]' value='"+item_to_add.id+"'>  </input></div>")}
else{item_exists.fadeOut(100).fadeIn(100)}}};taskjobs.show_moduletypes=function(t,e){taskjobs.hide_moduletypes_dropdown();taskjobs.hide_moduleitems_dropdown();$.ajax({url:t,data:{"moduletype":e,"method":$("#method_selected").text()},success:function(t,e,s){taskjobs.show_moduletypes_dropdown(t)}})};taskjobs.show_moduleitems=function(t,e,s){taskjobs.hide_moduleitems_dropdown();$.ajax({url:t,data:{"itemtype":s,"moduletype":e,"method":$("#method_selected").text()},success:function(t,e,s){taskjobs.show_moduleitems_dropdown(t)}})};taskjobs.Queue=$({refresh:0,timer:null});taskjobs.unfolds={targets:{},agents:{},executions:{}};var agents_dispatch=d3.dispatch("view");function pin_agent(t){var a=t.chart_id,e=t.data[0],s=taskjobs.agents_chart[a];s.pinned_agents[e]=s.agents.toObject()[e];s.pinned_agents[e].logs={};taskjobs.refresh_pinned_agents(a)};function add_runlogs(t){return function(e,s,a){var o=taskjobs.agents_chart[t.chart_id],n=o.pinned_agents[t.agent_id];if(n){n.logs[t.i]=e;agents_dispatch.view(t.chart_id)}}};taskjobs.refresh_pinned_agents=function(t){var e=taskjobs.agents_chart[t];$.each(e.pinned_agents,function(e,s){if(s){for(i=0;i<s.length;i++){if(i>0&&s.length>1&&s[i].jobstate_id==s[i-1].jobstate_id){continue};$.ajax({url:"../ajax/jobstates_logs.php",data:{"id":s[i].jobstate_id,"last_date":s[i].last_log_date},success:add_runlogs({"i":i,"agent_id":e,"chart_id":t})})}}})};function unpin_agent(t){var e=t.chart_id,s=t.data[0];delete taskjobs.agents_chart[e].pinned_agents[s];agents_dispatch.view(e)};function agent_is_pinned(t){var e=t.chart_id,s=t.data[0];return taskjobs.agents_chart[e].pinned_agents[s]};function agents_chart(t){var t=t;function e(e){e.each(function(e,s){var a=d3.select(this).selectAll("div.agent_block").data(e);a.enter().append("div");a.attr("class",function(e){var s=["agent_block",];if(agent_is_pinned({chart_id:t,data:e})){s.push("pinned")};var a=e[1].length;s.push("agent_"+e[1][0].state);return s.join(" ")}).each(function(e){var c=d3.select(this).selectAll("a.link").data([e]);c.enter().append("a").attr("class","link btn").attr("href",e[1][0].link);var r=d3.select(this).selectAll("input").data([e]);r.enter().append("input").attr("type","checkbox").attr("class","check_restart").attr("value",e[0]).on("click",function(e){var a=taskjobs.agents_chart[t],s=e[1][0].agent_id;if($(this).is(":checked")){a.checked_agents[s]=s}
else{delete a.checked_agents[s]};taskjobs.update_agents_view(t)});var s=d3.select(this).selectAll("a.name").data([e]);s.enter().append("a").attr("class","name").on("click",function(e){var s={chart_id:t,data:e};if(!agent_is_pinned(s)){pin_agent(s)}
else{unpin_agent(s)}});s.exit().remove();s.attr("href","javascript:void(0)").text(taskjobs.data.agents[e[0]]);var o=d3.select(this).selectAll("span.date").data([e]);o.enter().append("span").attr("class","date");o.html([e[1][0].last_log_date,].join("<br/>"));var n=d3.select(this).selectAll("span.comment").data([e]);n.enter().append("span").attr("class","comment");n.text(function(t){return[t[1][0].last_log+" "].join(",")});n.exit().remove();if(e[1][0].state=="error"){var i=d3.select(this).selectAll("a.restart").data([e]);s.enter().insert("a",".check_restart").attr("class","restart btn").attr("title","restart").on("click",function(t){$.ajax({url:"../ajax/restart_job.php",data:{"jobstate_id":t[1][0].jobstate_id,"agent_id":t[1][0].agent_id},complete:function(){taskjobs.queue_refresh_logs(taskjobs.ajax_url,taskjobs.task_id)}})}).append("i").attr("class","fa fa-bolt");s.exit().remove();s.attr("href","javascript:void(0)")};args={"chart_id":t,"data":e};var a=d3.select(this).selectAll("table.runs").data([agent_is_pinned(args)].filter(function(t){return(t&&t.logs)?!0:!1}));a.exit().remove();a.enter().append("table").attr("class","runs");a.each(function(t){var e=[];$.each(t.logs,function(t,s){e.push("<tr class='run header'><th colspan='3'>"+s.run+"</th></tr>");$.each(s.logs,function(t,s){e.push("<tr class='run log'><td>"+s["log.date"]+"</td><td>"+taskjobs.logstatuses_names[s["log.state"]]+"</td><td class='comment'>"+s["log.comment"]+"</td></tr>")});e.push("<tr class='run'><td class='void' colspan='4'></td></tr>")});$(this).html(e.join("\n"))})});a.exit().remove()})};return e};taskjobs.update_agents_view=function(t){if(taskjobs.agents_chart[t]){var e=taskjobs.agents_chart[t],s=Lazy([]),o=e.agents.toObject();Lazy(Object.keys(e.pinned_agents)).each(function(t){var s=e.pinned_agents[t].logs;e.pinned_agents[t]=o[t];e.pinned_agents[t].logs=s});pinned_agents=Lazy(e.pinned_agents);Lazy(Object.keys(e.type_selected)).each(function(t){s=s.union(e.counters[t])});s=s.map(function(t){return[t,!0]}).toObject();var a=e.agents.reject(function(t){if(e.pinned_agents[t[0]]){return!0};if(s[t[0]]){return!1}
else{return!0}}),n=Lazy(pinned_agents.toArray()).concat(a.toArray()).first(e.view_limit);taskjobs.agents_chart[t].filtered_agents=s;taskjobs.agents_chart[t].agents_to_view=n.toArray();taskjobs.agents_chart[t].total_agents_to_view=a.size()+pinned_agents.size();taskjobs.agents_chart[t].debug=a};taskjobs.agents_chart[t].display_agents=!0};taskjobs.display_agents_view=function(t){if(taskjobs.agents_chart[t].display_agents){var e=taskjobs.agents_chart[t],l=e.agents_to_view;d3.select(e.selector).datum(l).call(agents_chart(t));var s=e.total_agents_to_view-l.length;if(s<=0){taskjobs.agents_chart[t].view_limit=10};var a=10,n=[];if(s>0){a=Math.min(s,10)}
else{a=0};n=[{"text":"Show "+a+" more ("+(s)+" left)","limit":a}];var c=$(e.selector).parent()[0],i=d3.select(c).selectAll("div.show_more").selectAll("input.restart").data(n);i.enter().append("input");i.exit().remove();i.attr("type","button").attr("class","submit restart").attr("value","Restart selected jobs").style("display",function(t){return(Object.keys(e.checked_agents).length>0)?null:"none"}).on("click",function(t){$(".refresh_button > span").addClass("fetching");var s=[];$("input.check_restart:checked").each(function(t){var a=$(this).parent().index(),n=e.agents.toArray();s.push({"agent_id":n[a][1][0].agent_id,"jobstate_id":n[a][1][0].jobstate_id})});$.ajax({url:"../ajax/restart_job.php",method:"post",data:{"params":s},complete:function(){taskjobs.queue_refresh_logs(taskjobs.ajax_url,taskjobs.task_id);$("input.check_restart:checked").each(function(){$(this).attr("checked",!1)});$(".refresh_button > span").removeClass("fetching")}})});var r=d3.select(c).selectAll("div.show_more").selectAll("input.more_button").data(n);r.enter().append("input").attr("type","button").attr("class","submit more_button").on("click",function(e){taskjobs.agents_chart[t].view_limit+=e.limit;taskjobs.update_agents_view(t)});r.exit().remove();r.style("display",function(t){return(s>0)?null:"none"}).attr("disabled",function(t){return(t.limit>0)?null:"disabled"}).attr("value",function(t){return(t.text)});var o=d3.select(c).selectAll("div.show_more").selectAll("input.reset_button").data(n);o.enter().append("input").attr("type","button").attr("class","submit reset_button").on("click",function(e){taskjobs.agents_chart[t].view_limit=10;taskjobs.update_agents_view(t)});o.exit().remove();o.style("display",function(t){return(l.length>10)?null:"none"}).attr("value","Reset view");taskjobs.agents_chart[t].display_agents=!1}};agents_dispatch.on("view",function(t){taskjobs.update_agents_view(t)});taskjobs.toggle_details_type=function(t,e,s){view=!1;if(t._view){view=t._view};t._view=!view;if(t._view){taskjobs.agents_chart[s].type_selected[e]=!0}
else{delete taskjobs.agents_chart[s].type_selected[e]};$(t).toggleClass("expanded",t.view);agents_dispatch.view(s)};taskjobs.create_block=function(t,e,s){element=$(t);if(element.length===0){$(e).append($(s))}
else{$(t).remove();$(e).append($(s))}};var templates={};taskjobs.init_templates=function(){templates={task:$("#template_task").html(),job:$("#template_job").html(),target:$("#template_target").html(),target_name:$("#template_target_name").html(),target_stats:$("#template_target_stats").html(),counter_block:$("#template_counter_block").html(),counter_content:$("#template_counter_content").html(),agent:$("#template_agent").html(),};Lazy(templates).each(function(t){Mustache.parse(t)})};taskjobs.charts={};taskjobs.agents_chart={};taskjobs.update_logs=function(t){taskjobs.data=$.parseJSON(t);taskjobs.compute_data();blocks_seen={tasks:[],jobs:[],targets:[],charts:[],agents_chart:[],};tasks=taskjobs.data.tasks;tasks_selector=".tasks_block";$.each(tasks,function(t,e){task_id="task_"+e.task_id;task_name=e.task_name;task_selector="#"+task_id;blocks_seen.tasks.push(task_selector);taskjobs.create_block(task_selector,tasks_selector,Mustache.render(templates.task,{"task_id":task_id,"task_name":task_name,"expanded":e.expanded=="true"?"expand":""}));jobs_selector=task_selector+" .jobs_block";$.each(e.jobs,function(t,e){job_id=e.id;job_name=e.name;job_selector="#job_"+job_id;blocks_seen.jobs.push(job_selector);taskjobs.create_block(job_selector,jobs_selector,Mustache.render(templates.job,{"job_id":"job_"+job_id,"job_name":job_name}));targets_selector=job_selector+" .targets_block";var s=0;$.each(e.targets,function(t,a){target_id=t+"_"+s;s++;target_name=a.name;target_link=a.item_link;target_selector=task_selector+" #"+target_id;blocks_seen.targets.push(target_selector);var n="job_"+e.id+"_"+target_id;taskjobs.create_block(target_selector,targets_selector,Mustache.render(templates.target,{"target_id":target_id,"target_link":target_link,"target_name":target_name}));agents_selector=target_selector+" .agents_block";var r=null;if(Object.keys(a.agents).length>0){r=a.agents}
else{r=Lazy({})};if(!taskjobs.agents_chart[n]){taskjobs.agents_chart[n]={selector:agents_selector,type_selected:{},pinned_agents:{},checked_agents:{},view_limit:10,};d3.timer(function(){taskjobs.display_agents_view(n)},1000)};taskjobs.agents_chart[n].agents=r;taskjobs.agents_chart[n].counters=a.counters_computed;taskjobs.refresh_pinned_agents(n);agents_dispatch.view(n);counters_selector=target_selector+" .target_stats";$.each(taskjobs.statuses_order,function(t,e){stats_type_selector=target_selector+" ."+t;taskjobs.create_block(stats_type_selector,counters_selector,Mustache.render(templates.target_stats,{"stats_type":t}));$.each(e,function(t,e){counter_value=a.counters_computed[e];counter_type=e;counter_empty=(counter_value.length===0);counter_type_name=taskjobs.statuses_names[counter_type];counter_selector=target_selector+" ."+counter_type;taskjobs.create_block(counter_selector,stats_type_selector,Mustache.render(templates.counter_block,{"counter_empty":counter_empty,"counter_type":counter_type,"chart_id":n,"counter_type_name":counter_type_name,"counter_value":counter_value.length}))})});var o=[target_selector,".target_details","div.progressbar",].join(" > ");blocks_seen.charts.push("#chart_"+n);if($("#chart_"+n).length===0){taskjobs.charts[n]=taskjobs.create_progressbar(o,"chart_"+n,400,100);taskjobs.charts[n].new_data=[0,0,0];taskjobs.update_progressbar(taskjobs.charts[n])};taskjobs.charts[n].new_data=[a.counters_computed.agents_success.length,a.counters_computed.agents_error.length,a.counters_computed.agents_notdone.length];if(!d3.sum(taskjobs.charts[n].new_data)>0){$(o).addClass("empty")}
else{$(o).removeClass("empty")};$(counters_selector).show();$(target_selector).show()});$(job_selector).show()});$(task_selector).show()});$(".refresh_button span").removeClass("computing");if(taskjobs.blocks_seen){cache=taskjobs.blocks_seen;node_to_drop=Lazy([]).concat(Lazy(cache.tasks).without(blocks_seen.tasks).toArray()).concat(Lazy(cache.jobs).without(blocks_seen.jobs).toArray()).concat(Lazy(cache.targets).without(blocks_seen.targets).toArray()).concat(Lazy(cache.charts).without(blocks_seen.charts).toArray());$.each(node_to_drop.toArray(),function(t,e){$(e).remove()})};$(Object.keys(taskjobs.charts)).delay(500).each(function(t,e){taskjobs.update_progressbar(taskjobs.charts[e])});taskjobs.blocks_seen=blocks_seen;taskjobs.init_tasks_expand_buttons()};taskjobs.compute_data=function(){tasks=taskjobs.data.tasks;result=[];$.each(tasks,function(t,e){task=tasks[t];$.each(task.jobs,function(t,e){job=task.jobs[t];$.each(job.targets,function(t,e){e.counters_computed={agents_prepared:Object.keys(e.counters.agents_prepared),agents_running:Object.keys(e.counters.agents_running),agents_cancelled:Object.keys(e.counters.agents_cancelled),agents_notdone:Object.keys(e.counters.agents_notdone),agents_error:Object.keys(e.counters.agents_error),agents_success:Object.keys(e.counters.agents_success)};if(Object.keys(e.agents).length>0){e.agents=Lazy(e.agents).sortBy(function(t){return t[1][0].timestamp}).reverse()};counters=e.counters_computed;counters.agents_notdone=Lazy(counters.agents_notdone).toArray();counters.agents_total=Lazy(counters.agents_success).union(counters.agents_error).toArray()})})})};taskjobs.create_progressbar=function(t,e,s,a){var n=d3.select(t).append("svg").attr("id",e).attr("class","chart").attr("width",s).attr("height",a);origin=n.append("g").attr("transform","translate("+s/2+","+a+")");origin.append("g").attr("class","arcs");origin.append("g").attr("class","pointers");origin.append("g").attr("class","texts");n._width=s;return n};taskjobs.update_progressbar=function(e){var u=e.new_data;remapped=[];var l=0,a=d3.sum(u),d=Math.PI;if(a>0){u.forEach(function(e,s){t=Math.ceil((e/a)*16);remapped.push({real:e,value:t.toFixed(0),index:s,x0:l,x1:l+=+t})});e.style("display","")}
else{e.style("display","none")};var o=80,h=d3.scale.linear().domain([0,a]).range([0,100]),p=d3.scale.ordinal().domain([0,1,2]).range(["#8F8","#F33","#ccc"]),k=d3.scale.ordinal().domain([0,1,2]).range(["#0A0","#A00","#777"]),g=d3.format(".1s"),r=d3.layout.pie().value(function(t,e){if(a>0){return t.value}
else{if(e==3){return 100}}}).sort(null).startAngle(-90*(d/180)).endAngle(90*(d/180)),c=d3.svg.arc().innerRadius(o-25).outerRadius(o),n=e.select("g.arcs").selectAll("path.arc").data(r(remapped)),m={left:[],right:[]};n.enter().append("path").attr("class","arc").attr("fill",function(t,e){return p(e)}).each(function(t){this._current=t});var b=d3.dispatch("newangle");arcTween=function(t){var e=d3.interpolate(this._current,t);this._current=e(0);return function(t){i=e(t);return c(e(t))}};n.transition().duration(500).attrTween("d",arcTween);n.exit().remove();cursorposTween=function(t){var e=d3.interpolate(this._current,t);this._current=e(0);return function(t){return"translate("+c.centroid(e(t))+")"}};var s=e.select("g.texts").selectAll("text").data(r(remapped));s.enter().append("text").attr("text-anchor","middle").attr("font-size","0.5em").each(function(t){this._current=t});s.text(function(t){return h(t.data.real).toFixed(1)});s.attr("display",function(t){return((t.data.value>0)?"":"none")});s.transition().duration(500).attrTween("transform",cursorposTween);s.exit().remove()};taskjobs.get_logs=function(t,e){$(".refresh_button > span").addClass("fetching").removeClass("computing");var s={"task_id":e,"includeoldjobs":taskjobs.includeoldjobs,"refresh":taskjobs.refresh};$.ajax({url:t,data:s,success:function(t,e,s){$(".refresh_button > span").addClass("computing").removeClass("fetching");setTimeout(function(){taskjobs.update_logs(t)},50)},complete:function(){taskjobs.update_refresh_buttons(t,e);taskjobs.Queue.queue("refresh_logs").pop()}})};taskjobs.update_refresh_buttons=function(t,e){$(".refresh_button").off("click").on("click",function(s){taskjobs.queue_refresh_logs(t,e)})};taskjobs.init_include_old_jobs_buttons=function(t,e,s){$("#"+s).off("click").on("change",function(s){taskjobs.includeoldjobs=$(this).val();taskjobs.queue_refresh_logs(t,e)})};taskjobs.init_tasks_expand_buttons=function(){$(".monitoring-logs .task_block > h3").off("click").on("click",function(t){$(this).parent().toggleClass("expand");var e=$(this).parent().attr("id"),s=e.replace("task_","");$.ajax({url:"../ajax/expand_task.php",data:{"task_id":s,"expanded":$(this).parent().hasClass("expand")}})})};taskjobs.init_refresh_form=function(t,e,s){$("#"+s).off("change").on("change",function(){taskjobs.update_logs_timeout(t,e,s)})};taskjobs.update_logs_timeout=function(t,e,s){taskjobs.refresh=$("#"+s).val();window.clearTimeout(taskjobs.Queue.timer);taskjobs.queue_refresh_logs(t,e);if(taskjobs.refresh!="off"){taskjobs.Queue.refresh=taskjobs.refresh*1000;taskjobs.Queue.timer=window.setInterval(function(){taskjobs.queue_refresh_logs(t,e)},taskjobs.Queue.refresh)}
else{window.clearTimeout(taskjobs.Queue.timer)}};taskjobs.queue_refresh_logs=function(t,e){var s=taskjobs.Queue.queue("refresh_logs");$(".tasks_block:hidden").remove();if($(".tasks_block:visible").length===0){window.clearTimeout(taskjobs.Queue.timer)};if(s.length===0){taskjobs.Queue.queue("refresh_logs",function(){taskjobs.get_logs(t,e)});taskjobs.Queue.queue("refresh_logs")[0]()}};var expandtaskjobform=function(){$("#taskjobdisplay").css("overflow","visible").css("height","auto");$("#seemore").css("display","none")};$(document).ready(function(){$(document).on("click",".toggle_details_type",function(t){taskjobs.toggle_details_type($(this)[0],$(this).attr("data-counter_type"),$(this).attr("data-chart_id"))});$(document).on("click",".clear_list",function(t){taskjobs.clear_list($(this).attr("data-clear-param"))});$(document).on("click",".delete_items_selected",function(t){taskjobs.delete_items_selected($(this).attr("data-delete-param"))});$(document).on("click","#add_fusinv_job_item_button",function(t){taskjobs.add_item($(this).attr("data-moduletype"),$(this).attr("data-itemtype"),$(this).attr("data-itemtype_name"),$(this).attr("data-dropdown_rand_id"))});$(document).on("click",".show_moduletypes",function(t){taskjobs.show_moduletypes($(this).attr("data-ajaxurl"),$(this).attr("data-itemtype"),$(this).attr("data-method"))});$(document).on("click",".taskjobs_create",function(t){taskjobs.create($(this).attr("data-ajaxurl"),$(this).attr("data-task_id"))});$(document).on("click",".taskjobs_edit",function(t){taskjobs.edit($(this).attr("data-ajaxurl"),$(this).attr("data-taskjob_id"))});$(document).on("click",".openExportDialog",function(t){$("#fiTaskExport_modalWindow").dialog({modal:!0,resizeable:!0,height:200,width:480})});$(document).on("click",".task_export_form .submit",function(t){$("#fiTaskExport_modalWindow").dialog("close")})});