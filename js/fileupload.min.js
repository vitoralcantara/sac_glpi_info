;function uploadFile(e,t,n){var a=!1,i=new FormData();i.append("filename[0]",e,e.name);i.append("name","filename");$.ajax({type:"POST",url:CFG_GLPI.root_doc+"/ajax/fileupload.php",data:i,processData:!1,contentType:!1,dataType:"JSON",async:!1,success:function(i){$.each(i,function(i,r){if(r[0].error===undefined){a="";var o=getFileTag(r);if(isImage(e)){a=o.tag};displayUploadedFile(r[0],o,t,n)}
else{a=!1;alert(r[0].error)}})},error:function(e){if("responseText" in e&&e.responseText.length>0){alert(e.responseText)}
else{alert(e.statusText)}}});return a};var getFileTag=function(e){var t="";$.ajax({type:"POST",url:CFG_GLPI.root_doc+"/ajax/getFileTag.php",data:{"data":e},dataType:"JSON",async:!1,success:function(e){t=e[0]},error:function(e){console.log(e.responseText);t=!1}});return t},fileindex=0,displayUploadedFile=function(e,t,a,n){n=(typeof n==="undefined"||n==null)?"filename":n;var r=$(a.targetElm),o=0;do{r=r.parent();filecontainer=r.find(".fileupload_info");o++}
while(filecontainer.length<=0&&o<30);if(filecontainer.length){var d=e.name.split(".").pop(),i=$("<p/>").attr("id",e.id).html(getExtIcon(d)+"&nbsp;<b>"+e.display+"</b>&nbsp;("+getSize(e.size)+")&nbsp;").appendTo(filecontainer);$("<input/>").attr("type","hidden").attr("name","_"+n+"["+fileindex+"]").attr("value",e.name).appendTo(i);$("<input/>").attr("type","hidden").attr("name","_prefix_"+n+"["+fileindex+"]").attr("value",e.prefix).appendTo(i);$("<input/>").attr("type","hidden").attr("name","_tag_"+n+"["+fileindex+"]").attr("value",t.name).appendTo(i);var l={0:e.id,1:e.id+"2"};$("<span class=\"fa fa-times-circle pointer\"></span>").click(function(){deleteImagePasted(l,t.tag,a)}).appendTo(i);fileindex++}},deleteImagePasted=function(e,t,n){$.each(e,function(e,t){$("#"+t).remove()});if(typeof n!=="undefined"&&typeof n.dom!=="undefined"){n.setContent(n.getContent().replace("<p>"+t+"</p>",""));var a=new RegExp("#","g");n.dom.remove(t.replace(a,""))}},insertImgFromFile=function(e,t,n){var o=window.URL||window.webkitURL,l=o.createObjectURL(t),d=new RegExp("#","g"),i=$(tinyMCE.activeEditor.getContainer()).height()-60,r=$(tinyMCE.activeEditor.getContainer()).width()-120;if(window.FileReader&&window.File&&window.FileList&&window.Blob){e.setProgressState(!0);var a=new FileReader();a.onload=(function(t){var a=new Image();a.src=t.target.result;a.onload=function(){var t=this.width,a=this.height,o=0;if(t>r){o=r/t;a=a*o;t=t*o};if(a>i){o=i/a;t=t*o;a=a*o};e.execCommand("mceInsertContent",!1,"<img width='"+t+"' height='"+a+"'' id='"+n.replace(d,"")+"' src='"+l+"'>");e.setProgressState(!1)}});a.readAsDataURL(t)}
else{console.log("thanks to update your browser to get preview of image")}},dataURItoBlob=function(e){var t;if(e.split(",")[0].indexOf("base64")>=0){t=atob(e.split(",")[1])}
else{t=unescape(e.split(",")[1])};var r=e.split(",")[0].split(":")[1].split(";")[0],i=new Uint8Array(t.length);for(var n=0;n<t.length;n++){i[n]=t.charCodeAt(n)};var a=new Blob([i],{type:r});a.name="image_paste"+Math.floor((Math.random()*10000000)+1)+".png";return a},isImageFromPaste=function(e){return e.match(new RegExp("<img.*data:image\/"))!==null},isImageBlobFromPaste=function(e){return e.match(new RegExp("<img.*src=['\"]blob:"))!==null},extractSrcFromImgTag=function(e){var t=$("<div/>").append(e).find("img");if(t.length>0){return t.attr("src")};return""},insertImageInTinyMCE=function(e,t){var n=uploadFile(t,e);if(n!==!1){insertImgFromFile(e,t,n)};return n};if(typeof tinymce!="undefined"){tinymce.PluginManager.add("glpi_upload_doc",function(e){e.on("PastePreProcess",function(t){if(isImageFromPaste(t.content)){stopEvent(t);var a=extractSrcFromImgTag(t.content);if(a.length){var r=dataURItoBlob(a);insertImageInTinyMCE(e,r)}}
else if(isImageBlobFromPaste(t.content)){stopEvent(t);var i=extractSrcFromImgTag(t.content),n=new XMLHttpRequest();n.open("GET",i,!0);n.responseType="blob";n.onload=function(){if(this.status==200){var t=new Blob([this.response],{type:"image/png"});t.name="image_paste"+Math.floor((Math.random()*10000000)+1)+".png";insertImageInTinyMCE(e,t)}
else{console.error("paste error")}};n.send()}})})};$(function(){$(document).bind("dragover",function(e){e.preventDefault();var a=$(".dropzone"),i,r=window.dropZoneTimeout;if(!r){a.addClass("dragin")}
else{clearTimeout(r)};var n=!1,t=e.target;do{if($(t).hasClass("draghoverable")){n=!0;i=$(t);break};t=t.parentNode}
while(t!==null);a.removeClass("dragin draghover");if(n){i.addClass("draghover")}});$(document).bind("drop",function(e){e.preventDefault();$(".draghoverable").removeClass("draghover");if(typeof e.originalEvent.dataTransfer.files){$.each(e.originalEvent.dataTransfer.files,function(t,n){var a=null,i=$(e.target).find("input[type=file][name]");if(i.length){a=i.attr("name").replace("[]","")};uploadFile(n,{targetElm:$(e.target).find(".fileupload_info")},a)})}})});